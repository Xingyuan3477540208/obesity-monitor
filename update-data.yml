name: Update Dashboard Data Daily

on:
  schedule:
    # æ¯å¤© UTC 01:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 09:00ï¼Œç¾ä¸œæ—¶é—´ 20:00/21:00ï¼‰
    - cron: '0 1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¯æ¬¡pushåˆ°mainæ—¶ä¹Ÿè¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'scripts/update_dashboard_data.py'
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºæŸ¥çœ‹æ•°æ®å˜åŒ–
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests pandas yfinance beautifulsoup4 feedparser
        pip install pytz  # æ—¶åŒºå¤„ç†
    
    - name: ğŸ” Verify dependencies
      run: |
        python -c "import yfinance; print('âœ“ yfinance installed')"
        python -c "import feedparser; print('âœ“ feedparser installed')"
        python -c "import pandas; print('âœ“ pandas installed')"
    
    - name: ğŸ“Š Run data update script
      run: |
        cd scripts
        python update_dashboard_data.py
      env:
        # å¯é€‰ï¼šæ·»åŠ  API keysï¼ˆå¦‚æœéœ€è¦ï¼‰
        # ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        TZ: 'America/New_York'  # è®¾ç½®æ—¶åŒº
    
    - name: âœ… Verify generated data
      run: |
        if [ ! -f "public/dashboard_data.json" ]; then
          echo "âŒ Error: dashboard_data.json not generated!"
          exit 1
        fi
        
        FILE_SIZE=$(stat -f%z "public/dashboard_data.json" 2>/dev/null || stat -c%s "public/dashboard_data.json")
        echo "ğŸ“„ Generated file size: ${FILE_SIZE} bytes"
        
        if [ "$FILE_SIZE" -lt 100 ]; then
          echo "âŒ Error: File too small, update may have failed"
          exit 1
        fi
        
        # éªŒè¯ JSON æ ¼å¼
        python -c "
import json
with open('public/dashboard_data.json') as f:
    data = json.load(f)
    print(f'âœ“ Valid JSON with {len(data.get(\"marketData\", []))} stocks')
    print(f'âœ“ {len(data.get(\"intelligenceFeed\", []))} news items')
    print(f'âœ“ Last update: {data.get(\"lastUpdate\", \"N/A\")}')
"
    
    - name: ğŸ“ˆ Generate update summary
      id: summary
      run: |
        python scripts/generate_summary.py > update_summary.txt
        cat update_summary.txt
        
        # æå–å…³é”®ä¿¡æ¯ç”¨äºcommit message
        STOCKS_COUNT=$(python -c "import json; data=json.load(open('public/dashboard_data.json')); print(len(data.get('marketData', [])))")
        NEWS_COUNT=$(python -c "import json; data=json.load(open('public/dashboard_data.json')); print(len(data.get('intelligenceFeed', [])))")
        
        echo "stocks_count=${STOCKS_COUNT}" >> $GITHUB_OUTPUT
        echo "news_count=${NEWS_COUNT}" >> $GITHUB_OUTPUT
    
    - name: ğŸ“¦ Backup to archive
      run: |
        mkdir -p archive
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        cp public/dashboard_data.json "archive/dashboard_data_${TIMESTAMP}.json"
        
        # åªä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
        find archive -name "dashboard_data_*.json" -mtime +30 -delete
    
    - name: ğŸ“ Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add public/dashboard_data.json
        git add archive/
        git add update_summary.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No data changes detected"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ¤– Auto-update: ${TIMESTAMP}

ğŸ“Š Market Data: ${{ steps.summary.outputs.stocks_count }} stocks
ğŸ“° News Items: ${{ steps.summary.outputs.news_count }} articles

Generated by GitHub Actions
Workflow: ${{ github.workflow }}
Run: ${{ github.run_number }}"
          
          git push
          echo "âœ… Changes committed and pushed"
        fi
    
    - name: ğŸš€ Trigger Vercel deployment (optional)
      if: success()
      run: |
        # Vercel ä¼šè‡ªåŠ¨æ£€æµ‹ GitHub å˜åŒ–å¹¶éƒ¨ç½²
        # è¿™æ­¥å¯é€‰ï¼Œä»…ç”¨äºå¼ºåˆ¶è§¦å‘
        if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
          echo "âœ“ Vercel deployment triggered"
        else
          echo "â„¹ï¸ No Vercel deploy hook configured"
        fi
    
    - name: ğŸ“Š Create status badge
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "![Status](https://img.shields.io/badge/update-success-green)" > status.md
        else
          echo "![Status](https://img.shields.io/badge/update-failed-red)" > status.md
        fi
    
    - name: ğŸ’¬ Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š Data Update Summary
            
            **Status**: âœ… Success
            **Stocks Updated**: ${{ steps.summary.outputs.stocks_count }}
            **News Items**: ${{ steps.summary.outputs.news_count }}
            **Timestamp**: ${new Date().toISOString()}
            
            The dashboard data has been successfully updated.`
          })
    
    - name: ğŸ“§ Send notification on failure
      if: failure()
      run: |
        echo "âŒ Update failed! Check logs for details."
        # å¯é€‰ï¼šé›†æˆ Slack/Discord webhook
        # curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"Dashboard update failed! Check GitHub Actions."}'

# å¯é€‰ï¼šæ·»åŠ å®šæ—¶æ¸…ç†æ—§æ•°æ®çš„job
  cleanup-old-archives:
    runs-on: ubuntu-latest
    needs: update-data
    if: github.event.schedule == '0 1 * * *'  # åªåœ¨å®šæ—¶ä»»åŠ¡æ—¶è¿è¡Œ
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ—‘ï¸ Clean old archives
      run: |
        find archive -name "dashboard_data_*.json" -mtime +30 -delete
        echo "âœ“ Cleaned archives older than 30 days"
    
    - name: ğŸ“ Commit cleanup
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add archive/
          git commit -m "ğŸ—‘ï¸ Cleanup: Remove archives older than 30 days"
          git push
        fi
