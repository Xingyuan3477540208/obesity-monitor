name: Update Dashboard Data Daily

on:
  schedule:
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests yfinance --break-system-packages

      - name: Fetch stock data with historical prices
        run: |
          python << 'EOF'
          import json
          import yfinance as yf
          from datetime import datetime, timedelta

          print("ğŸ“Š å¼€å§‹æ¯æ—¥æ•°æ®æ›´æ–°...")
          print(f"â° æ›´æ–°æ—¶é—´: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC")
          print("")

          tickers = ['LLY', 'NVO', 'VKTX', 'AMGN', 'RHHBY', 'PFE']
          
          stocks_data = []
          historical_data = {}
          
          end_date = datetime.now()
          start_date = end_date - timedelta(days=180)
          
          print("ğŸ“ˆ è·å–è‚¡ç¥¨æ•°æ®:")
          print("-" * 60)
          
          for ticker_symbol in tickers:
              try:
                  ticker = yf.Ticker(ticker_symbol)
                  info = ticker.info
                  
                  hist_recent = ticker.history(period='2d')
                  if len(hist_recent) >= 2:
                      current_price = hist_recent['Close'].iloc[-1]
                      prev_close = hist_recent['Close'].iloc[-2]
                      change = current_price - prev_close
                      change_percent = (change / prev_close) * 100
                  else:
                      current_price = info.get('currentPrice', 0)
                      prev_close = info.get('previousClose', current_price)
                      change = current_price - prev_close
                      change_percent = (change / prev_close) * 100 if prev_close else 0
                  
                  hist_6m = ticker.history(start=start_date, end=end_date)
                  
                  history = []
                  for index, row in hist_6m.iterrows():
                      history.append({
                          'date': index.strftime('%Y-%m-%d'),
                          'price': round(row['Close'], 2)
                      })
                  
                  historical_data[ticker_symbol] = history
                  
                  market_cap = info.get('marketCap', 0)
                  if market_cap >= 1e12:
                      market_cap_str = f"{market_cap / 1e12:.1f}T"
                  elif market_cap >= 1e9:
                      market_cap_str = f"{market_cap / 1e9:.1f}B"
                  elif market_cap >= 1e6:
                      market_cap_str = f"{market_cap / 1e6:.1f}M"
                  else:
                      market_cap_str = str(market_cap)
                  
                  stock_data = {
                      'ticker': ticker_symbol,
                      'company': info.get('longName', ticker_symbol),
                      'price': round(current_price, 2),
                      'change': round(change, 2),
                      'changePercent': round(change_percent, 2),
                      'marketCap': market_cap_str
                  }
                  
                  stocks_data.append(stock_data)
                  
                  change_icon = "ğŸ“ˆ" if change >= 0 else "ğŸ“‰"
                  print(f"{change_icon} {ticker_symbol:6} ${current_price:8.2f} ({change_percent:+.2f}%) | å†å²: {len(history)} å¤©")
                  
              except Exception as e:
                  print(f"âŒ {ticker_symbol:6} è·å–å¤±è´¥: {e}")
                  continue
          
          print("-" * 60)
          
          output_data = {
              'lastUpdated': datetime.utcnow().isoformat() + 'Z',
              'updateFrequency': 'daily',
              'stocks': stocks_data,
              'historicalData': historical_data
          }
          
          with open('public/dashboard_data.json', 'w') as f:
              json.dump(output_data, f, indent=2)
          
          print("")
          print("âœ… æ•°æ®æ›´æ–°å®Œæˆ!")
          print(f"   ğŸ“Š {len(stocks_data)} åªè‚¡ç¥¨")
          print(f"   ğŸ“ˆ {len(historical_data)} åªè‚¡ç¥¨çš„å†å²æ•°æ®")
          
          total_days = sum(len(hist) for hist in historical_data.values())
          print(f"   ğŸ“… æ€»å…± {total_days} å¤©æ•°æ®ç‚¹")
          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add public/dashboard_data.json
          
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ•°æ®å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ“Š Daily update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€åˆ° GitHub"
          fi
