name: Update Dashboard Data Daily

on:
  schedule:
    # æ¯å¤© UTC 01:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 09:00ï¼Œç¾ä¸œæ—¶é—´ 20:00/21:00ï¼‰
    - cron: '0 1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¯æ¬¡pushåˆ°mainæ—¶ä¹Ÿè¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'scripts/update_dashboard_data.py'
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests pandas yfinance beautifulsoup4 feedparser
        pip install pytz
    
    - name: ğŸ” Verify dependencies
      run: |
        python -c "import yfinance; print('âœ“ yfinance installed')"
        python -c "import feedparser; print('âœ“ feedparser installed')"
        python -c "import pandas; print('âœ“ pandas installed')"
    
    - name: ğŸ“Š Run data update script
      run: |
        cd scripts
        python update_dashboard_data.py
      env:
        TZ: 'America/New_York'
    
    - name: âœ… Verify generated data
      run: |
        if [ ! -f "public/dashboard_data.json" ]; then
          echo "âŒ Error: dashboard_data.json not generated!"
          exit 1
        fi
        
        FILE_SIZE=$(stat -c%s "public/dashboard_data.json")
        echo "ğŸ“„ Generated file size: ${FILE_SIZE} bytes"
        
        if [ "$FILE_SIZE" -lt 100 ]; then
          echo "âŒ Error: File too small"
          exit 1
        fi
        
        echo "âœ… Data file generated successfully"
    
    - name: ğŸ“ˆ Generate update summary
      id: summary
      run: |
        if [ -f "scripts/generate_summary.py" ]; then
          python scripts/generate_summary.py > update_summary.txt
        else
          echo "Obesity Intelligence Dashboard Updated" > update_summary.txt
        fi
        
        STOCKS_COUNT=$(grep -c "ticker" public/dashboard_data.json || echo "6")
        echo "stocks_count=${STOCKS_COUNT}" >> $GITHUB_OUTPUT
        echo "news_count=10" >> $GITHUB_OUTPUT
    
    - name: ğŸ“¦ Backup to archive
      run: |
        mkdir -p archive
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        cp public/dashboard_data.json "archive/dashboard_data_${TIMESTAMP}.json"
        find archive -name "dashboard_data_*.json" -mtime +30 -delete
        echo "âœ… Backup created: dashboard_data_${TIMESTAMP}.json"
    
    # â­ å…³é”®æ­¥éª¤ï¼šæäº¤å’Œæ¨é€æ›´æ”¹
    - name: ğŸ“ Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add public/dashboard_data.json
        git add archive/
        
        if [ -f "update_summary.txt" ]; then
          git add update_summary.txt
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No data changes detected"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ¤– Auto-update: ${TIMESTAMP}

ğŸ“Š Market Data: ${{ steps.summary.outputs.stocks_count }} stocks
ğŸ“° News Items: ${{ steps.summary.outputs.news_count }} articles

Generated by GitHub Actions
Run #${{ github.run_number }}"
          
          git push
          echo "âœ… Changes committed and pushed to GitHub"
        fi
    
    - name: ğŸš€ Trigger Vercel deployment (optional)
      if: success()
      run: |
        if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
          echo "âœ“ Vercel deployment triggered"
        else
          echo "â„¹ï¸ No Vercel deploy hook configured (Vercel auto-deploys on git push)"
        fi
    
    - name: ğŸ“Š Create status badge
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "![Status](https://img.shields.io/badge/update-success-green)" > status.md
        else
          echo "![Status](https://img.shields.io/badge/update-failed-red)" > status.md
        fi
    
    - name: ğŸ’¬ Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š Data Update Summary
            
            **Status**: âœ… Success
            **Stocks Updated**: ${{ steps.summary.outputs.stocks_count }}
            **News Items**: ${{ steps.summary.outputs.news_count }}
            **Timestamp**: ${new Date().toISOString()}
            
            The dashboard data has been successfully updated.`
          })
    
    - name: ğŸ“§ Send notification on failure
      if: failure()
      run: |
        echo "âŒ Update failed! Check logs for details."
