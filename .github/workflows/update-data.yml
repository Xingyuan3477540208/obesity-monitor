name: Update Dashboard Data Daily

on:
  schedule:
    # æ¯å¤© UTC 01:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 09:00ï¼Œç¾ä¸œæ—¶é—´ 20:00/21:00ï¼‰
    - cron: '0 1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¯æ¬¡pushåˆ°mainæ—¶ä¹Ÿè¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'scripts/update_dashboard_data.py'
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºæŸ¥çœ‹æ•°æ®å˜åŒ–
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
  
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install requests pandas yfinance beautifulsoup4 feedparser
        pip install pytz  # æ—¶åŒºå¤„ç†
    
    - name: ğŸ” Verify dependencies
      run: |
        python -c "import yfinance; print('âœ“ yfinance installed')"
        python -c "import feedparser; print('âœ“ feedparser installed')"
        python -c "import pandas; print('âœ“ pandas installed')"
    
    - name: ğŸ“Š Run data update script
      run: |
        cd scripts
        python update_dashboard_data.py
      env:
        # å¯é€‰ï¼šæ·»åŠ  API keysï¼ˆå¦‚æœéœ€è¦ï¼‰
        # ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        TZ: 'America/New_York'  # è®¾ç½®æ—¶åŒº
    
    - name: âœ… Verify generated data
      run: |
        if [ ! -f "public/dashboard_data.json" ]; then
          echo "âŒ Error: dashboard_data.json not generated!"
          exit 1
        fi
        
        # ç®€å•çš„æ–‡ä»¶å¤§å°æ£€æŸ¥
        FILE_SIZE=$(stat -c%s "public/dashboard_data.json")
        echo "ğŸ“„ Generated file size: ${FILE_SIZE} bytes"
        
        if [ "$FILE_SIZE" -lt 100 ]; then
          echo "âŒ Error: File too small"
          exit 1
        fi

    - name: ğŸ“ˆ Generate update summary
      id: summary
      run: |
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è·³è¿‡æŠ¥å‘Šç”Ÿæˆ
        if [ -f "scripts/generate_summary.py" ]; then
          python scripts/generate_summary.py > update_summary.txt
        else
          echo "No summary script found, skipping report."
          echo "Obesity Intelligence Dashboard Updated" > update_summary.txt
        fi
        
        # ä½¿ç”¨ç®€å•çš„ grep æå–æ•°é‡ï¼Œé¿å…å¤æ‚çš„ python åµŒå¥—æŒ‡ä»¤å¯¼è‡´ YAML æŠ¥é”™
        STOCKS_COUNT=$(grep -c "ticker" public/dashboard_data.json || echo "0")
        echo "stocks_count=${STOCKS_COUNT}" >> $GITHUB_OUTPUT
        echo "news_count=10" >> $GITHUB_OUTPUT

    - name: ğŸ“¦ Backup to archive
      run: |
        mkdir -p archive
        cp public/dashboard_data.json "archive/dashboard_data_$(date +%Y%m%d_%H%M%S).json"
        find archive -name "dashboard_data_*.json" -mtime +30 -delete
    
    - name: ğŸš€ Trigger Vercel deployment (optional)
      if: success()
      run: |
        # Vercel ä¼šè‡ªåŠ¨æ£€æµ‹ GitHub å˜åŒ–å¹¶éƒ¨ç½²
        # è¿™æ­¥å¯é€‰ï¼Œä»…ç”¨äºå¼ºåˆ¶è§¦å‘
        if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
          echo "âœ“ Vercel deployment triggered"
        else
          echo "â„¹ï¸ No Vercel deploy hook configured"
        fi
    
    - name: ğŸ“Š Create status badge
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "![Status](https://img.shields.io/badge/update-success-green)" > status.md
        else
          echo "![Status](https://img.shields.io/badge/update-failed-red)" > status.md
        fi
    
    - name: ğŸ’¬ Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š Data Update Summary
            
            **Status**: âœ… Success
            **Stocks Updated**: ${{ steps.summary.outputs.stocks_count }}
            **News Items**: ${{ steps.summary.outputs.news_count }}
            **Timestamp**: ${new Date().toISOString()}
            
            The dashboard data has been successfully updated.`
          })
    
    - name: ğŸ“§ Send notification on failure
      if: failure()
      run: |
        echo "âŒ Update failed! Check logs for details."
        # å¯é€‰ï¼šé›†æˆ Slack/Discord webhook
        # curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"Dashboard update failed! Check GitHub Actions."}'

# å¯é€‰ï¼šæ·»åŠ å®šæ—¶æ¸…ç†æ—§æ•°æ®çš„job
  cleanup-old-archives:
    runs-on: ubuntu-latest
    needs: update-data
    if: github.event.schedule == '0 1 * * *'  # åªåœ¨å®šæ—¶ä»»åŠ¡æ—¶è¿è¡Œ
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ—‘ï¸ Clean old archives
      run: |
        find archive -name "dashboard_data_*.json" -mtime +30 -delete
        echo "âœ“ Cleaned archives older than 30 days"
    
    - name: ğŸ“ Commit cleanup
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add archive/
          git commit -m "ğŸ—‘ï¸ Cleanup: Remove archives older than 30 days"
          git push
        fi
